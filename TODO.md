# CodeMap 專案 - 狀態報告與待辦事項 (Jules 版本)

**[最後更新於 2025-08-14]**

---

## 🚨 執行摘要

經過一番艱苦但成果豐碩的奮戰，我們成功解決了之前**完全阻斷**開發的測試環境掛起問題。根本原因令人驚訝：並非程式碼邏輯錯誤，而是 `tsconfig.json` 中一個不當的 `exclude` 配置，導致了 Vitest 模塊解析器在處理本地路徑別名（`@/`）時崩潰。

在清除了這個最底層的障礙後，我們建立了一套全新的、健壯的測試環境安裝 (`vitest-setup.ts`)，它能正確地模擬包括 Next.js 路由、瀏覽器 API (`fetch`, `matchMedia`) 和圖標庫在內的全局依賴。

然而，這個過程也揭示了一個更深層次的問題：現有的測試套件過於依賴在 JSDOM 中進行大規模的集成測試。這種方法不僅脆弱，而且資源消耗極大，導致了反覆的內存溢出。即使在環境修復後，許多測試仍然因為複雜的模擬和渲染鏈而難以維護。

**結論：** 繼續修補現有的集成測試套件是得不償失的。作為架構師，我建議我們進行一次**戰略轉向**，用更現代、更穩定、更高效的測試方法來取代它。

---

## ✅ 已完成的史詩級任務

### **1. [已解決] 修復測試環境掛起與崩潰問題**
- **成果**:
    - [x] **定位並修復了 `tsconfig.json`** 中導致測試解析器掛起的 `exclude` 問題。
    - [x] **建立了一個全新的、乾淨的 `vitest-setup.ts`**，正確地模擬了全局依賴（环境变量、`next/navigation`、`fetch`、`lucide-react` 等）。
    - [x] **建立了針對複雜 Zustand Store 的內聯模擬模式**，並成功應用於修復多個核心 hooks 的測試。
    - [x] **使 `npm test` 命令能夠完整運行**，不再出現無聲的掛起或內存溢出。測試失敗現在是可預測、可調試的。

---

## 🔴 最高優先級：測試策略轉型

### **2. [戰略] 徹底改革專案的測試策略**
- **問題**: 當前的測試套件過於依賴脆弱且資源密集的集成測試，導致難以維護且效率低下。
- **目標**: 建立一個分層的、現代化的、可持續的測試金字塔。
- **執行計畫**:
    - [ ] **第一步：歸檔脆弱的測試**
        -   將 `src/app/(app)/examples/__tests__` 和 `src/contexts/__tests__` 等目錄下的測試檔案重命名為 `.skip` 或直接刪除。它們的測試意圖很好，但實現方式已被證明是不可靠的。
    - [ ] **第二步：為核心服務與 Hooks 補全單元測試**
        -   為 `src/services` 和 `src/hooks` 下的關鍵業務邏輯編寫純粹的單元測試。
        -   這些測試應直接模擬其依賴的函數，而不渲染任何 UI，確保其快速、穩定。
    - [ ] **第三步：引入 Storybook 進行元件驅動開發 (CDD)**
        -   為 `src/components` 中的通用元件（如 `Button`, `Card`）編寫 Storybook stories。
        -   這將使我們能夠在隔離的環境中進行視覺化測試和基本交互測試，遠比 JSDOM 高效。
    - [ ] **第四步：實現關鍵流程的 E2E 測試**
        -   使用 Playwright 為 1-2 個最核心的用戶流程編寫端到端測試。建議的候選流程：
            1.  用戶註冊 -> 登錄 -> 成功看到儀表板。
            2.  用戶從儀表板點擊「New Map」-> 成功進入編輯器頁面。
- **預期成果**: 大幅提升測試套件的穩定性和運行速度，為開發提供更可靠的信心，並降低維護成本。

---

## 🟠 第二優先級：架構重構與技術債 (從舊版繼承)

> 這些任務依然重要，但在測試策略轉型完成後，執行起來會更有保障。

### **3. [架構] 重構「上帝物件」狀態儲存 (`concept-map-store`)**
- **問題**: `src/stores/concept-map-store.ts` 是一個巨大的單體式 Store，職責混亂。
- **執行計畫**:
    - [ ] **分析與拆分**: 將其拆分為 `MapDataStore`, `MapMetaStore`, `EditorUIStore`, `AIStateStore` 等。
    - [ ] **重構元件**: 更新使用此 store 的元件。
- **進度**: `useMapSaver` 和 `useMapLoader` 的修復過程已經開始了這個重構，應繼續完成。

### **4. [實作] 實現真實的 AI 流程**
- **問題**: `src/ai/flows/` 中的功能是硬式編碼的。
- **執行計畫**:
    - [ ] 接入真實的 AI API，並處理邊界情況。

### **5. [品質] 統一測試檔案存放位置**
- **問題**: `__tests__` 和 `src/tests` 並存。
- **執行計畫**:
    - [ ] 團隊決策後統一（建議與元件共置）。

---

## 🟡 第三優先級：次要改進 (從舊版繼承)

### **6. [品質] 增強 `runFlow` AI 分派器的型別安全**
- **問題**: `src/ai/flows/index.ts` 中的 `runFlow` 函式使用了 `as any`。
- **執行計畫**:
    - [ ] 利用 TypeScript 的高級類型來增強型別安全。

### **7. [架構] 資料庫結構與查詢效能審查**
- **背景**: 專案的資料庫結構尚未經過審查。
- **執行計畫**:
    - [ ] 審查 Schema 設計與索引。
    - [ ] 評估 `src/services` 中的查詢效能。
