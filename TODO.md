# CodeMap 專案 - 狀態報告與待辦事項 (Jules 版本)

**[最後更新於 2025-08-14]**

---

## 🚨 執行摘要

經過一番艱苦但成果豐碩的奮戰，我們成功解決了之前**完全阻斷**開發的測試環境掛起問題。根本原因令人驚訝：並非程式碼邏輯錯誤，而是 `tsconfig.json` 中一個不當的 `exclude` 配置，導致了 Vitest 模塊解析器在處理本地路徑別名（`@/`）時崩潰。

在清除了這個最底層的障礙後，我們建立了一套全新的、健壯的測試環境安裝 (`vitest-setup.ts`)，它能正確地模擬包括 Next.js 路由、瀏覽器 API (`fetch`, `matchMedia`) 和圖標庫在內的全局依賴。

然而，這個過程也揭示了一個更深層次的問題：現有的測試套件過於依賴在 JSDOM 中進行大規模的集成測試。這種方法不僅脆弱，而且資源消耗極大，導致了反覆的內存溢出。

**結論：** 繼續修補現有的集成測試套件是得不償失的。作為架構師，我們已經執行了一次**戰略轉向**，用更現代、更穩定、更高效的測試方法來取代它。

---

## ✅ 已完成的史詩級任務

### **1. [已解決] 修復測試環境掛起與崩潰問題**
- **成果**:
    - [x] **定位並修復了 `tsconfig.json`** 中導致測試解析器掛起的 `exclude` 問題。
    - [x] **建立了一個全新的、乾淨的 `vitest-setup.ts`**，正確地模擬了全局依賴（环境变量、`next/navigation`、`fetch`、`lucide-react` 等）。
    - [x] **建立了針對複雜 Zustand Store 的內聯模擬模式**，並成功應用於修復多個核心 hooks 的測試。
    - [x] **使 `npm test` 命令能夠完整運行**，不再出現無聲的掛起或內存溢出。測試失敗現在是可預測、可調試的。
- **後續行動**:
    - [x] **歸檔了最不穩定的測試檔案** (`auth-context.test.tsx`, `examples/page.test.tsx`)，為新的測試策略掃清了道路。
    - [x] **建立了純粹單元測試的黃金標準**，為 `userService.ts` 和 `conceptMapService.ts` 添加了快速、可靠的單元測試。

---

## 🔴 最高優先級：架構重構與核心邏輯強化

> **戰略轉向**: 由於 Storybook 在當前環境中遇到無法解決的啟動超時問題，我們將暫時擱置 UI 測試層的建設，將最高優先級轉向解決現有架構中的核心技術債。這將為未來的 UI 開發和測試提供一個更穩定的基礎。

### **2. [架構] 重構「上帝物件」狀態儲存 (`concept-map-store`)**
- **問題**: `src/stores/concept-map-store.ts` 是一個巨大的單體式 Zustand Store，混合了地圖數據、UI 狀態、AI 建議和元數據，導致職責不清、難以測試和維護。
- **目標**: 將其拆分為多個獨立、專注的 stores，實踐關注點分離原則。
- **執行計畫**:
    - [ ] **第一步: 分析與拆分**: 將單體 store 分解為 `MapDataStore` (節點/邊數據), `EditorViewStore` (視圖狀態如縮放/平移), `EditorHistoryStore` (撤銷/重做), 和 `AISuggestionStore` (AI相關狀態)。
    - [ ] **第二步: 增量重構**: 逐一重構使用舊 store 的核心 hooks (`useMapLoader`, `useMapSaver`, `useEditorActions`) 和元件，使其依賴於新的、更小的 stores。
    - [ ] **第三步: 驗證**: 確保在重構過程中，所有相關功能（地圖加載、保存、編輯）保持正常工作。
- **進度**: `useMapSaver` 和 `useMapLoader` 的修復過程已經開始了這個重構，應繼續完成。

### **3. [測試] 繼續為核心服務與 Hooks 補全單元測試**
- **狀態**: 已為 `userService`, `conceptMapService`, `classroomService` 建立良好基礎。
- **下一步**:
    - [ ] 為 `src/hooks/useConceptMapDataManager.ts` 添加單元測試，因為它與即將重構的 store 緊密相關。
    - [ ] 繼續為 `src/hooks` 目錄下的其他關鍵邏輯補全測試。

---

## 🟠 第二優先級：剩餘技術債 (從舊版繼承)

### **4. [實作] 實現真實的 AI 流程**
- **問題**: `src/ai/flows/` 中的功能是硬式編碼的。
- **執行計畫**:
    - [ ] 接入真實的 AI API，並處理邊界情況。

### **5. [品質] 統一測試檔案存放位置**
- **問題**: `__tests__` 和 `src/tests` 並存。
- **執行計畫**:
    - [ ] 團隊決策後統一（建議與元件共置）。

---

## 🟡 已擱置：UI 測試層 (待環境問題解決)

### **6. [UI 測試] 引入 Storybook 進行元件驅動開發 (CDD)**
- **狀態**: **已擱置**
- **問題**: `storybook init` 和 `storybook dev` 命令在當前環境中均遭遇不明原因的超時失敗 (超過 6 分鐘)。即使將故事範圍限制到單一目錄也無法解決。
- **結論**: 在底層工具鏈問題被解決之前，繼續投入時間的成本過高。

### **7. [UI 測試] 實現關鍵流程的 E2E 測試**
- **狀態**: **已擱置**
- **依賴**: 依賴一個穩定的開發/測試環境，Storybook 的問題可能預示著 Playwright 同樣會遇到挑戰。待 Storybook 問題解決後再重新評估。

### **4. [實作] 實現真實的 AI 流程**
- **問題**: `src/ai/flows/` 中的功能是硬式編碼的。
- **執行計畫**:
    - [ ] 接入真實的 AI API，並處理邊界情況。

### **5. [品質] 統一測試檔案存放位置**
- **問題**: `__tests__` 和 `src/tests` 並存。
- **執行計畫**:
    - [ ] 團隊決策後統一（建議與元件共置）。

---

## 🟡 第三優先級：次要改進 (從舊版繼承)

### **6. [品質] 增強 `runFlow` AI 分派器的型別安全**
### **7. [架構] 資料庫結構與查詢效能審查**
