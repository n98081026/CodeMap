# CodeMap 專案 - 狀態報告與待辦事項

**[最後更新於 2025-08-04 22:23]** 此狀態經反覆測試後再次確認。

## 🚨 **嚴重警告：開發環境問題** 🚨

**狀態：** **完全阻塞**

經過詳盡的調查，當前的開發與測試環境存在根本性問題，導致無法執行任何測試，甚至無法穩定地安裝專案依賴 (`npm install`)。所有嘗試（包括執行 `vitest` 和 `npm install`）均以超時告終。

**這不是程式碼的錯誤，而是基礎設施的問題。** 在這個環境問題得到解決之前，任何程式碼層面的修改、修復或功能開發都無法被驗證，因此無法安全地進行。

---

## 📋 待辦事項 (當環境恢復正常後)

### **第一優先級：修復並驗證測試框架**

這些是根據偵錯過程中的發現，必須優先處理的任務，以確保專案的穩定性。

1.  **[ ] (驗證) 移除 Vitest 配置中的 `forks` 進程池**
    -   **問題**: `vitest.config.ts` 中使用 `pool: 'forks'` 的配置，這在某些環境下可能導致進程掛起。
    -   **建議的修復**: 移除 `pool` 和 `poolOptions` 區塊，讓 Vitest 使用預設的 `threads` 模式。
    -   **驗證**: 必須確認 `npm test` 命令能夠啟動、執行並完成（無論是通過還是失敗），而不是超時。

2.  **[ ] (修復) 全面審查並重構 `vi.mock` 的使用**
    -   **問題**: 專案中大量存在 `vi.mock` 的反模式用法，其工廠函數使用了 `async` 和 `await vi.importActual`。這會導致測試執行器在啟動時掛起。
    -   **發現位置**:
        -   `src/tests/setup.ts` (已在偵錯中嘗試修復)
        -   `src/tests/minimal.test.tsx` (已在偵錯中嘗試修復)
        -   *可能存在於專案中其他 `*.test.tsx` 檔案中。*
    -   **建議的修復**:
        -   將所有 `vi.mock` 的工廠函數改為同步返回。
        -   如果需要 mock 檔案中的某些導出，應使用靜態 `import * as mock from '...'`，然後在工廠函數中返回 `mock`。
        -   應在整個專案中搜索 `vi.mock`，並修復所有類似的實例。

3.  **[ ] (修復) 移除 Mock 檔案中的頂層 `await`**
    -   **問題**: 在 `src/tests/__mocks__/next/navigation.ts` 中發現了頂層 `await`，這會阻塞模組加載，是導致掛起的另一個主要原因。
    -   **建議的修復**: 確保所有 `__mocks__` 目錄下的檔案都是完全同步的。移除所有頂層 `await`。如果需要 `importActual`，應在測試案例內部需要的地方按需調用，而不是在模組的頂層。

### **第二優先級：程式碼品質與健全性**

1.  **[ ] (重構) 重新評估並簡化 Mock 策略**
    -   **問題**: `lucide-react` 的 mock 非常龐大且需要手動維護。`next/navigation` 的 mock 試圖動態轉發未被 mock 的導出，這很脆弱。
    -   **建議**:
        -   為 `lucide-react` 創建一個更通用的 mock，例如一個返回簡單 div 的代理組件，而不是為每個圖示都創建 mock。
        -   簡化所有 mock，使其只 mock 必要的部分，不要試圖變得過於“智能”。

2.  **[ ] (審查) 依賴項檢查**
    -   **問題**: `package.json` 中存在大量依賴，其中一些可能已過時或不再需要。
    -   **建議**: 運行 `npx depcheck` 並分析結果，移除不必要的依賴。運行 `npm audit` 來識別並修復已知的安全漏洞。

### **第三優先級：功能與部署**

此部分來自舊的 `TODO.md`，在以上所有技術債被償還後，可以繼續進行。

1.  **[ ] (配置) 設置生產環境變數**
    -   根據 `.env.example` 配置實際的生產環境變數。

2.  **[ ] (部署) 部署前檢查**
    -   確保 `NEXT_PUBLIC_BYPASS_AUTH=false` 或相應的安全開關在生產環境中被正確設置。

3.  **[ ] (監控) 設置監控**
    -   考慮為生產環境加入錯誤監控（如 Sentry）和效能監控（如 Vercel Analytics）。

4.  **[ ] (文檔) 更新文檔**
    -   在所有變更穩定後，更新部署和開發者文檔。

---

**舊的 `TODO.md` 已被此文件取代，以準確反映專案的真實技術狀態。** 原來的內容聲稱專案“已達生產標準”，但嚴重的測試基礎設施問題表明事實並非如此。
