# CodeMap 專案 - 狀態報告與待辦事項 (Jules 版本)

**[最後更新於 2025-08-13]**

---

## 🚨 執行摘要

本專案擁有一個設計精良、高度模組化的現代前端架構。其在元件設計、關注點分離以及 AI 功能的解耦方面，都展現了卓越的工程實踐。

然而，專案當前存在一個**致命的、阻斷性的問題**：**測試環境完全無法運作**。所有測試都會無限期掛起，導致無法驗證任何程式碼變更。

經過深入調查，問題的根源令人驚訝：先前一份標記為「已解決」的修復方案 (`vitest-setup-enhanced.ts` 中的全域模擬) 正是當前故障的直接原因。這表示專案的文檔狀態與實際狀態存在嚴重脫節。

以下待辦事項旨在**首先解決這個阻斷性問題**，然後處理在程式碼審查中發現的其他架構性技術債，最終將專案帶回健康的、可持續發展的軌道。

---

## 🔴 最高優先級：阻斷性問題修復

### **1. [阻斷] 修復測試環境掛起問題**
- **問題**: `npm test` 會無限期掛起，即使是執行一個最簡單的測試檔案。
- **根本原因**: `src/tests/vitest-setup-enhanced.ts` 中對 `zustand` 和 `zundo` 的全域模擬策略存在根本性缺陷，導致 Vitest 在初始化階段即進入死鎖。先前的 `TODO.md` 錯誤地將此檔案標記為解決方案。
- **執行計畫**:
    - [ ] **第一步：移除錯誤的模擬**
        -   從 `vitest.config.ts` 中完全移除 `setupFiles` 設定，或清空 `vitest-setup-enhanced.ts` 的內容，以證明測試執行器本身可以運作。
    - [ ] **第二步：建立新的測試策略**
        -   放棄全域模擬 `zustand` store 的策略。
        -   在需要測試 store 的測試檔案中（如 `concept-map-store.test.ts`），採用局部模擬或建立真實 store 實例進行測試。
    - [ ] **第三步：逐一修復受影響的測試**
        -   執行 `npm test`，預計會有大量測試因缺少全域模擬而失敗。
        -   逐一修復這些測試，為每個測試提供其所需的最小化、局部化的依賴模擬。
- **預期成果**: `npm test` 能夠快速、可靠地完成所有測試，為後續開發提供安全保障。

---

## 🟠 第二優先級：架構重構與技術債

### **2. [架構] 重構「上帝物件」狀態儲存 (`concept-map-store`)**
- **問題**: `src/stores/concept-map-store.ts` 是一個巨大的單體式 Store，混合了 UI 狀態、資料狀態、AI 邏輯、使用者互動模式等多種職責，導致可維護性差、性能潛在問題且極難測試（這是導致測試問題的根源）。
- **執行計畫**:
    - [ ] **分析與拆分**: 將 `ConceptMapState` 拆分為多個獨立的、職責單一的 store。建議拆分方向：
        -   `MapDataStore`: 只管理 `nodes` 和 `edges`。
        -   `MapMetaStore`: 管理地圖的元數據，如 `mapName`, `mapId`。
        -   `EditorUIStore`: 管理編輯器的 UI 狀態，如 `selectedElementId`, `isConnectingMode`。
        -   `AIStateStore`: 管理所有與 AI 相關的狀態，如 `stagedMapData`, `ghostPreviewData`。
    - [ ] **重構元件**: 更新使用此 store 的元件（主要是 `FlowCanvasCore`），使其從新的、更小的 store 中獲取狀態。
- **預期成果**: 提升狀態管理的可維護性、性能與可測試性。為修復測試環境提供極大便利。

### **3. [實作] 實現真實的 AI 流程**
- **問題**: `src/ai/flows/` 中的所有 AI 功能目前都是返回硬式編碼資料的模擬實現。
- **執行計畫**:
    - [ ] 選擇一個 AI 服務 (如 Google AI - Genkit, OpenAI)。
    - [ ] 在 `extract-concepts.ts`, `suggest-relations.ts` 等檔案中，替換模擬邏輯為對真實 AI API 的呼叫。
    - [ ] 確保處理 API 的錯誤、延遲等邊界情況。
- **預期成果**: AI 功能真正可用。

### **4. [品質] 統一測試檔案存放位置**
- **問題**: 專案同時使用了與元件共置的 `__tests__` 目錄和一個全域的 `src/tests` 目錄。
- **執行計畫**:
    - [ ] 團隊決策選擇一種策略（建議使用與元件共置的 `__tests__`，因為這更符合模組化原則）。
    - [ ] 將所有測試檔案遷移到選定的位置。
- **預期成果**: 提升程式碼庫的一致性和可維護性。

---

## 🟡 第三優先級：次要改進

### **5. [品質] 增強 `runFlow` AI 分派器的型別安全**
- **問題**: `src/ai/flows/index.ts` 中的 `runFlow` 函式使用了 `as any`，削弱了 TypeScript 的型別保護。
- **執行計畫**:
    - [ ] 研究使用 TypeScript 的條件類型或對應類型，建立一個從 `command` 字串到其對應 `payload` 和 `return` 型別的映射。
- **預期成果**: 提高 AI 模組的內部健壯性。

### **6. [架構] 資料庫結構與查詢效能審查**
- **背景**: 專案使用 Supabase (PostgreSQL)，但其資料庫結構 (Schema) 的設計與查詢效能尚未經過審查。
- **執行計畫**:
    - [ ] **結構審查**: 分析資料表的設計、欄位型別、索引和關聯，確保其符合最佳實踐。
    - [ ] **效能評估**: 檢查 `src/services` 中的 Supabase 查詢，評估其在大量資料下的潛在效能瓶頸。
- **預期成果**: 確保後端資料層的可擴展性和高效能，預防未來的效能問題。
